name: Automatic Organization Invitation

on:
  push:
    branches:
      - 'main'
    paths:
      - 'members.json'

jobs:
  invite_members:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Find and Invite New Members to amFOSS
        env:
          ORG_NAME: amfoss
          # This must be a PAT with 'admin:org' scope
          GH_TOKEN: ${{ secrets.ORG_INVITER_TOKEN }} 
        run: |
          echo "--- Starting Member Invitation Process ---"

          # 1. Capture JSON content safely into Env Vars
          # We use EOF delimiters to handle multi-line JSON safely
          echo "CURRENT_JSON_CONTENT<<EOF" >> $GITHUB_ENV
          cat members.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "PREVIOUS_JSON_CONTENT<<EOF" >> $GITHUB_ENV
          git show HEAD~1:members.json || echo '[]' >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Process Invites
        env:
          ORG_NAME: amfoss
          GH_TOKEN: ${{ secrets.ORG_INVITER_TOKEN }}
        run: |
          # 2. Run Python using os.environ (Prevents syntax crashing)
          NEW_USERNAMES=$(python3 - <<'EOF'
          import os
          import json
          import sys
          import re

          # Read from Environment Variables instead of direct injection
          current_raw = os.environ.get('CURRENT_JSON_CONTENT', '[]')
          previous_raw = os.environ.get('PREVIOUS_JSON_CONTENT', '[]')

          try:
              current_members = json.loads(current_raw)
          except json.JSONDecodeError:
              print("Error decoding current members.json", file=sys.stderr)
              sys.exit(1)

          try:
              previous_members = json.loads(previous_raw)
          except json.JSONDecodeError:
              previous_members = []
              
          # Extract GitHub Links
          # Handles cases where githubLink key might be missing
          current_links = {m.get('githubLink') for m in current_members if m.get('githubLink')}
          previous_links = {m.get('githubLink') for m in previous_members if m.get('githubLink')}

          new_links = current_links - previous_links

          new_usernames = []
          for link in new_links:
              # Regex to find username (handles http, https, www, and trailing slashes)
              match = re.search(r'github\.com/([^/]+)/?', link)
              if match:
                  new_usernames.append(match.group(1))

          print(" ".join(new_usernames))
          EOF
          )

          if [ -z "$NEW_USERNAMES" ]; then
            echo "No new members found. Invitation skipped."
            exit 0
          fi

          echo "Found new members to invite: $NEW_USERNAMES"

          # 3. Loop and Invite
          for username in $NEW_USERNAMES; do
            if [ -n "$username" ]; then
              echo "Processing user $username..."
              
              # Get User ID (More reliable than username for invites)
              USER_ID=$(gh api \
                -H "Accept: application/vnd.github.v3+json" \
                /users/"$username" --jq '.id')

              if [ -z "$USER_ID" ] || [ "$USER_ID" = "null" ]; then
                echo "ERROR: Could not find user: $username. Skipping."
                continue
              fi

              # Send Invitation
              gh api \
                --method POST \
                -H "Accept: application/vnd.github.v3+json" \
                /orgs/$ORG_NAME/invitations \
                -f invitee_id="$USER_ID" \
                -f role='member' 
                
              echo "Invitation sent successfully to $username (ID: $USER_ID)."
            fi
          done
